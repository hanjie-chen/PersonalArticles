# Docker Compose 默认网络

当你使用 Docker Compose 启动项目时，Compose 会自动为所有服务创建一个默认网络。默认情况下，这个网络是一个 bridge 网络。所有在同一个 Compose 文件中定义的服务都会加入这个网络。

由于所有服务都在同一个网络内，它们可以通过容器的 IP 地址直接相互通信，而无需显式暴露端口到宿主机。不过更方便的是，Docker 内置了 DNS 解析机制，可以让你直接通过服务的名称来访问容器。



# DNS

Docker 在默认网络中，会自动启用一个内置的 DNS 服务器，该服务器通常监听在容器内的 `127.0.0.11`。当容器内部发起 DNS 请求时（例如访问 `web-app`），这个内置 DNS 服务器会自动查找当前网络中所有容器的注册信息，并返回相应的 IP 地址。

## 内置 DNS 服务器与 127.0.0.11

Docker Engine 为每个容器提供了一个内置的 DNS 服务，这个服务并不是运行在一个独立的容器或独立进程中，而是作为 Docker 网络功能的一部分实现的。为了让容器内的进程能够通过域名解析找到其他容器，Docker 在启动容器时，会在容器的 `/etc/resolv.conf` 中配置一个指向 `127.0.0.11` 的 nameserver。

### 为什么是 127.0.0.11？

的确，127.0.0.0/8 范围内通常表示回环地址（loopback），这意味着数据包不会离开容器的网络栈。而 Docker 则利用这一特性，在每个容器内“虚拟”出一个 DNS 服务器地址 `127.0.0.11`。当容器内的应用进行 DNS 查询时，查询被发送到这个地址，实际上会被 Docker 的内置 DNS 解析器接管和处理。

### DNS 请求如何工作：

当你在一个容器（比如 nginx）中请求 `web-app` 这个主机名时，容器的 DNS 解析库会根据 `/etc/resolv.conf` 里的配置，将请求发送到 `127.0.0.11`。此时，Docker 内部的 DNS 模块会查询当前网络中的容器注册信息，并返回 `web-app` 所对应的 IP 地址。这个过程对容器内部来说是透明的，无需做额外设置。

## DNS name

在 docker-compose.yml 中，每个服务的键名（例如 `web-app`）就是该服务在内部网络中的名称。无论你是否在服务里指定了 `container_name`，Compose 都会将服务名称（即 YML 文件中的键名）自动注册到这个网络里。例如：

```yaml
services:
  web-app:
    container_name: web-app
    build:
      context: ./web-app
      dockerfile: Dockerfile
    # 其他配置...
```

在上例中，`web-app` 就是服务名称，其他容器（例如 nginx）就可以通过 `web-app` 来解析并访问这个容器的 IP 地址。



## `/ect/resolv.conf`

每个容器内部的 `/etc/resolv.conf` 文件中，默认会包含 Docker 内置 DNS 的地址（例如 `nameserver 127.0.0.11`）。这保证了所有的 DNS 查询都会首先询问 Docker 提供的解析服务，而不是直接请求宿主机或外部 DNS 服务器。

```shell
cat resolv.conf
# Generated by Docker Engine.
# This file can be edited; Docker Engine will not make further changes once it
# has been modified.

nameserver 127.0.0.11
search pzt3xnjh0akubiunuoujeoe0if.ix.internal.cloudapp.net
options edns0 trust-ad ndots:0

# Based on host file: '/etc/resolv.conf' (internal resolver)
# ExtServers: [host(127.0.0.53)]
# Overrides: []
# Option ndots from: internal
```

这文件并不是用来存储 DNS 记录的，而是告诉容器的 DNS 解析库去哪里查找域名信息。解释如下：

- **nameserver 127.0.0.11**
  表示所有 DNS 查询最终都会发送到 `127.0.0.11`（也就是 Docker 内置的 DNS 服务）。这并不意味着 `127.0.0.11` 上预先存在某个 A 记录信息，而是查询时由 Docker 动态解析。
- **search 域设置**
  `search` 指令指定了默认的搜索域，当你查询一个不完整的主机名时，系统可能会自动在后面加上此搜索域。
- **options 配置**
  这些配置项为 DNS 查询提供额外的参数，例如启用扩展 DNS（EDNS0）、信任认证数据等。

所以，即使 `/etc/resolv.conf` 中没有静态定义某个服务对应的 A 记录，实际上 DNS 查询是动态通过 Docker 内置 DNS 服务处理的，这个服务会依据当前 Docker 网络（例如 docker-compose 自动创建的网络）中容器的注册信息返回正确的 IP 地址。

这个内置 DNS 服务由 Docker Engine 管理，它根据容器之间的网络注册情况（例如由 docker-compose.yml 定义的服务名称）动态解析主机名。